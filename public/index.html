<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adaptive Emotion Identifier Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-image: url("Mckfeelingsbkrd.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    .step { display: none; }
    .step.active { display: block; }
    .slider-row { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; }
    .slider-label { width: 120px; text-align: center; }

    input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: #ddd;
      border-radius: 3px;
      outline: none;
      margin: 0 10px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #4CAF50;
      border-radius: 50%;
      cursor: pointer;
      margin-top: -5px;
    }

    .navigation button, .start-btn, .help-btn {
      background: url("Cloud.png") no-repeat center center;
      background-size: contain;
      border: none;
      color: #000;
      font-weight: bold;
      font-size: 1rem;
      padding: 30px 60px;
      margin: 5px;
      cursor: pointer;
      text-align: center;
      text-shadow: 0 0 2px #fff;
    }

    .progress-container { margin-top: 20px; }
    .progress-label { font-weight: bold; margin-bottom: 5px; }
    .progress-bar { width: 100%; height: 10px; background-color: #eee; border-radius: 5px; overflow: hidden; }
    .progress-fill { width: 0%; height: 100%; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s ease; }

    #details { margin-top: 1em; }
    .ai-results, .fallback-results { background: #fff; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .ai-results p { font-size: 1.2rem; text-align: center; }
  </style>
</head>
<body>

  <div id="intro" class="step active">
    <h1>Emotion Identifier Quiz</h1>
    <p>This quiz helps you pinpoint your current feeling by guiding you through slider-based questions drawn from therapeutic techniques.</p>
    <button class="start-btn" onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="step0" class="step">
    <h2>1. Are you feeling more self-directed or other-directed?</h2>
    <div class="slider-row">
      <span class="slider-label">Self</span>
      <input id="slider0" type="range" min="1" max="5" step="1" value="3" />
      <span class="slider-label">Others</span>
    </div>
    <div class="navigation">
      <button class="help-btn" onclick="showHelp()">Help</button>
      <button onclick="handleFirst()">Next</button>
    </div>
    <div class="progress-container">
      <div class="progress-label">Progress</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
    </div>
  </div>

  <div id="question-step" class="step">
    <h2 id="qHeader"></h2>
    <div class="slider-row">
      <span class="slider-label" id="leftLabel"></span>
      <input id="slider" type="range" min="1" max="5" step="1" value="3" />
      <span class="slider-label" id="rightLabel"></span>
    </div>
    <div class="navigation">
      <button onclick="prevAdaptive()">Back</button>
      <button onclick="nextAdaptive()">Next</button>
    </div>
    <div class="progress-container">
      <div class="progress-label">Progress</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar-2"></div></div>
    </div>
  </div>

  <div id="results" class="step">
    <h2>Your Emotional Snapshot</h2>
    <div id="output"></div>
    <button onclick="location.reload()">Start Over</button>
  </div>

  <script>
    const branchA = [
      { prompt: 'Are you feeling calm or agitated?', left: 'Calm', right: 'Agitated' },
      { prompt: 'Is your calm more peaceful or contented?', left: 'Peaceful', right: 'Contented' },
      { prompt: 'If agitated, is it restless or tense?', left: 'Restless', right: 'Tense' }
    ];
    const branchB = [
      { prompt: 'Is your focus affectionate or resentful?', left: 'Affectionate', right: 'Resentful' },
      { prompt: 'Do you feel supportive or critical?', left: 'Supportive', right: 'Critical' },
      { prompt: 'Is your resentment mild irritation or deep anger?', left: 'Irritation', right: 'Deep Anger' }
    ];

    let currentBranch = [], stepIndex = 0;
    const answers = {};

    function startQuiz() {
      document.getElementById('intro').classList.remove('active');
      document.getElementById('step0').classList.add('active');
      updateProgress(0, 1);
    }

    function handleFirst() {
      const val = +document.getElementById('slider0').value;
      answers["Q1"] = { prompt: "Self-directed vs Other-directed", value: val };
      currentBranch = val >= 3 ? branchB : branchA;
      document.getElementById('step0').classList.remove('active');
      stepIndex = 0;
      showAdaptive();
    }

    function showAdaptive() {
      const q = currentBranch[stepIndex];
      document.getElementById('qHeader').textContent = `${stepIndex + 2}. ${q.prompt}`;
      document.getElementById('leftLabel').textContent = q.left;
      document.getElementById('rightLabel').textContent = q.right;
      document.getElementById('question-step').classList.add('active');
      updateProgress(stepIndex, currentBranch.length);
    }

    function prevAdaptive() {
      document.getElementById('question-step').classList.remove('active');
      if (stepIndex === 0) {
        document.getElementById('step0').classList.add('active');
      } else {
        stepIndex--;
        showAdaptive();
      }
    }

    async function nextAdaptive() {
      const val = +document.getElementById('slider').value;
      const q = currentBranch[stepIndex];
      answers[`Q${stepIndex+2}`] = { prompt: q.prompt, value: val };

      document.getElementById('question-step').classList.remove('active');
      if (stepIndex < currentBranch.length - 1) {
        stepIndex++;
        showAdaptive();
      } else {
        await showResults();
      }
    }

    async function showResults() {
      document.getElementById('results').classList.add('active');

      try {
        const response = await fetch("https://emotion-api-0y8p.onrender.com/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ answers })
        });

        const data = await response.json();
        const emotion = data.emotion || "(no response)";
        document.getElementById('output').innerHTML =
          `<div class="ai-results"><p>Most likely emotion: <strong>${emotion}</strong></p></div>`;
      } catch (err) {
        document.getElementById('output').innerHTML =
          `<div class="fallback-results"><p>There was a problem getting your result. Try again later.</p></div>`;
        console.error(err);
      }
    }

    function updateProgress(idx, total) {
      const pct = Math.round(((idx + 1) / (total + 1)) * 100);
      document.getElementById(idx === 0 ? 'progress-bar' : 'progress-bar-2').style.width = pct + "%";
    }

    function showHelp() {
      alert("Use the slider to show which feeling is stronger for you. Then continue to the next question.");
    }
  </script>
</body>
</html>
