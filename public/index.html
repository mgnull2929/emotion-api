<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adaptive Emotion Identifier Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-image: url("Mckfeelingsbkrd.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }

    .step { display: none; }
    .step.active { display: block; }
    .slider-row { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; }
    .slider-label { width: 120px; text-align: center; }

    input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: #ddd;
      border-radius: 3px;
      outline: none;
      margin: 0 10px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #4CAF50;
      border-radius: 50%;
      cursor: pointer;
      margin-top: -5px;
    }

    .navigation button, .start-btn, .help-btn {
      background: url("Cloud.png") no-repeat center center;
      background-size: contain;
      border: none;
      color: #000;
      font-weight: bold;
      font-size: 1rem;
      padding: 30px 60px;
      margin: 5px;
      cursor: pointer;
      text-align: center;
      text-shadow: 0 0 2px #fff;
    }

    .progress-container { margin-top: 20px; }
    .progress-label { font-weight: bold; margin-bottom: 5px; }
    .progress-bar { width: 100%; height: 10px; background-color: #eee; border-radius: 5px; overflow: hidden; }
    .progress-fill { width: 0%; height: 100%; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s ease; }

    #details { margin-top: 1em; }
    .ai-results, .fallback-results { background: #fff; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .ai-results p { font-size: 1.2rem; text-align: center; }
  </style>
</head>
<body>

  <div id="intro" class="step active">
    <h1>Emotion Identifier Quiz</h1>
    <p>This quiz helps you pinpoint your current feeling by guiding you through slider-based questions drawn from therapeutic techniques.</p>
    <button class="start-btn" onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="step0" class="step">
    <h2>1. Are you feeling more self-directed or other-directed?</h2>
    <div class="slider-row">
      <span class="slider-label">Self</span>
      <input id="slider0" type="range" min="1" max="5" step="1" value="3" />
      <span class="slider-label">Others</span>
    </div>
    <div class="navigation">
      <button class="help-btn" onclick="showHelp()">Help</button>
      <button onclick="handleFirst()">Next</button>
    </div>
    <div class="progress-container">
      <div class="progress-label">Progress</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
    </div>
  </div>

  <div id="question-step" class="step">
    <h2 id="qHeader"></h2>
    <div class="slider-row">
      <span class="slider-label" id="leftLabel"></span>
      <input id="slider" type="range" min="1" max="5" step="1" value="3" />
      <span class="slider-label" id="rightLabel"></span>
    </div>
    <div class="navigation">
      <button onclick="prevAdaptive()">Back</button>
      <button onclick="nextAdaptive()">Next</button>
    </div>
    <div class="progress-container">
      <div class="progress-label">Progress</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-bar-2"></div></div>
    </div>
  </div>

  <div id="results" class="step">
    <h2>Your Emotional Snapshot</h2>
    <div id="output"></div>
    <button onclick="location.reload()">Start Over</button>
  </div>

  <script>
    const branchA = [
      { prompt: 'Are you feeling calm or agitated?', left: 'Calm', right: 'Agitated' },
      { prompt: 'Is your calm more peaceful or contented?', left: 'Peaceful', right: 'Contented' },
      { prompt: 'If agitated, is it restless or tense?', left: 'Restless', right: 'Tense' }
    ];
    const branchB = [
      { prompt: 'Is your focus affectionate or resentful?', left: 'Affectionate', right: 'Resentful' },
      { prompt: 'Do you feel supportive or critical?', left: 'Supportive', right: 'Critical' },
      { prompt: 'Is your resentment mild irritation or deep anger?', left: 'Irritation', right: 'Deep Anger' }
    ];

    let currentBranch = [], stepIndex = 0;
    const answers = {};

    function startQuiz() {
      document.getElementById('intro').classList.remove('active');
      document.getElementById('step0').classList.add('active');
      updateProgress(0, 1);
    }

    function handleFirst() {
      const val = +document.getElementById('slider0').value;
      answers["Q1"] = { prompt: "Self-directed vs Other-directed", value: val };
      currentBranch = val >= 3 ? branchB : branchA;
      document.getElementById('step0').classList.remove('active');
      stepIndex = 0;
      showAdaptive();
    }

    function showAdaptive() {
      const q = currentBranch[stepIndex];
      document.getElementById('qHeader').textContent = `${stepIndex + 2}. ${q.prompt}`;
      document.getElementById('leftLabel').textContent = q.left;
      document.getElementById('rightLabel').textContent = q.right;
      document.getElementById('question-step').classList.add('active');
      updateProgress(stepIndex, currentBranch.length);
    }

    function prevAdaptive() {
      document.getElementById('question-step').classList.remove('active');
      if (stepIndex === 0) {
        document.getElementById('step0').classList.add('active');
      } else {
        stepIndex--;
        showAdaptive();
      }
    }

    async function nextAdaptive() {
      const val = +document.getElementById('slider').value;
      const q = currentBranch[stepIndex];
      answers[`Q${stepIndex+2}`] = { prompt: q.prompt, value: val };

      document.getElementById('question-step').classList.remove('active');
      if (stepIndex < currentBranch.length - 1) {
        stepIndex++;
        showAdaptive();
      } else {
        await showResults();
      }
    }

    
  async function showResults() {
    const terms = Object.entries(answers)
      .filter(([k]) => k.startsWith("Term"))
      .map(([, v]) => v)
      .filter(Boolean);

    // fallback: no AI results
    if (terms.length === 0) {
      const syn = {
        Calm: ["peaceful", "serene", "tranquil"], Agitated: ["restless", "anxious", "irritable"],
        Peaceful: ["calm", "quiet", "soothing"], Contented: ["satisfied", "pleased", "comfortable"],
        Restless: ["uneasy", "fidgety", "antsy"], Tense: ["nervous", "tight", "strained"],
        Affectionate: ["loving", "fond", "warm"], Resentful: ["bitter", "spiteful", "angry"],
        Supportive: ["encouraging", "helpful", "caring"], Critical: ["judgmental", "disapproving", "fault-finding"],
        Irritation: ["annoyance", "vexation", "aggravation"], "Deep Anger": ["fury", "rage", "wrath"]
      };

      const lines = [];
      Object.keys(answers).filter(k => k.startsWith("Q")).forEach(qk => {
        const num = qk.slice(1);
        const val = answers[qk];
        const q = (num === "1") ? "self-directed vs other-directed" : currentBranch[Number(num) - 2].prompt;
        const { left, right } = (num === "1") ? { left: "Self", right: "Others" } : currentBranch[Number(num) - 2];
        const lean = val > 3 ? right : val < 3 ? left : "balanced";
        const choices = syn[lean] || ["(no synonyms available)"];
        lines.push(`Q${num} (${q}): you chose ${val} â†’ ${lean}. Could also be ${choices.join(", ")}.`);
      });

      document.getElementById('output').innerHTML =
        `<div class="fallback-results">${lines.map(l => `<p>${l}</p>`).join("")}</div>`;
    } else {
      // NEW: full AI analysis of all responses
      const rawQuestions = Object.entries(answers)
        .filter(([k]) => k.startsWith("Q"))
        .map(([k, v]) => {
          const i = +k.slice(1) - 2;
          const prompt = k === "Q1" ? "self-directed vs other-directed" : currentBranch[i]?.prompt;
          return { prompt, value: v };
        });

      let overallTerm = null;
      try {
        const resp = await fetch("https://emotion-api-0y8p.onrender.com/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ questions: rawQuestions })
        });
        const data = await resp.json();
        overallTerm = data.overall;
      } catch (err) {
        console.warn("AI analyze error:", err);
      }

      const freq = terms.reduce((f, t) => (f[t] = (f[t] || 0) + 1, f), {});
      const total = terms.length;
      const top3 = Object.entries(freq)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([t, c]) => `<li><strong>${t}</strong>: ${Math.round(c / total * 100)}%</li>`);

      const summary = overallTerm
        ? `<p><strong>Overall:</strong> ${overallTerm}</p>`
        : "";

      document.getElementById('output').innerHTML =
        `<div class="ai-results">${summary}<ul>${top3.join("")}</ul></div>`;
    }

    document.getElementById('results').classList.add('active');
  }


    function updateProgress(idx, total) {
      const pct = Math.round(((idx + 1) / (total + 1)) * 100);
      document.getElementById(idx === 0 ? 'progress-bar' : 'progress-bar-2').style.width = pct + "%";
    }

    function showHelp() {
      alert("Use the slider to show which feeling is stronger for you. Then continue to the next question.");
    }
  </script>
</body>
</html>
